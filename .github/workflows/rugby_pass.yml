name: Weekly Rugby Digest

on:
  schedule:
    - cron: '0 7 * * 1'  # Weekly on Monday at 7 AM UTC (after TV + events)
  workflow_dispatch:  # Manual trigger

jobs:
  create-digest:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Generate weekly digest
      id: digest
      run: |
        echo "# ðŸ‰ Weekly Rugby Digest" > digest.md
        echo "" >> digest.md
        echo "Generated: $(date -u '+%Y-%m-%d %H:%M UTC')" >> digest.md
        echo "" >> digest.md
        
        echo "## ðŸ“º TV Schedule" >> digest.md
        echo '```' >> digest.md
        python main.py tv --days 7 >> digest.md 2>&1
        echo '```' >> digest.md
        echo "" >> digest.md
        
        echo "## ðŸ“† Calendar Events" >> digest.md
        echo '```' >> digest.md
        python main.py events --days 7 >> digest.md 2>&1
        echo '```' >> digest.md
        echo "" >> digest.md
        
        echo "## ðŸŒ How to Watch" >> digest.md
        echo "" >> digest.md
        echo "### Streaming Options" >> digest.md
        echo "- **[RugbyPass TV](https://rugbypass.tv)** - International coverage" >> digest.md
        echo "- **[FloRugby](https://www.florugby.com)** - US coverage" >> digest.md
        echo "- **[Stan Sport](https://www.stan.com.au/sport)** - Australia" >> digest.md
        echo "- **[Sky Sports](https://www.skysports.com/rugby-union)** - UK/Ireland" >> digest.md
        echo "" >> digest.md
        echo "### Free Streams" >> digest.md
        echo "- Check [Mike Riversdale Calendar](https://www.mikeriversdale.co.nz/rugby-calendar) for fixtures" >> digest.md
        echo "- Some matches on YouTube Rugby channels" >> digest.md
        echo "" >> digest.md
        
        # Check if any rugby content exists
        if grep -q "ðŸ‰" digest.md; then
          echo "has_content=true" >> $GITHUB_OUTPUT
        else
          echo "has_content=false" >> $GITHUB_OUTPUT
        fi
        
        cat digest.md

    - name: Create or update digest issue
      if: steps.digest.outputs.has_content == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const body = fs.readFileSync('digest.md', 'utf8');
          const date = new Date().toISOString().split('T')[0];
          
          const title = `ðŸ‰ Weekly Rugby Digest - Week of ${date}`;
          
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'weekly-digest',
            state: 'open'
          });
          
          if (issues.data.length > 0) {
            // Close old issue and create new one for the new week
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues.data[0].number,
              state: 'closed'
            });
          }
          
          // Always create fresh issue for new week
          const newIssue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['weekly-digest', 'automated', 'pinned']
          });
          
          // Pin the issue
          console.log(`Created digest issue #${newIssue.data.number}`);

    - name: No content this week
      if: steps.digest.outputs.has_content == 'false'
      run: echo "No rugby content this week - skipping digest"
